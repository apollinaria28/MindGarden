<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>–ù–∞—Å—Ç—Ä–æ–π–∫–∏ - MindGarden</title>
    <link rel="stylesheet" href="style.css">
    <link rel="manifest" href="manifest.json">
        <!-- –ò–∫–æ–Ω–∫–∞ –¥–ª—è iOS -->
    <link rel="apple-touch-icon" href="icons/icon-152x152.png">

    <!-- –¶–≤–µ—Ç –∞–¥—Ä–µ—Å–Ω–æ–π —Å—Ç—Ä–æ–∫–∏ –±—Ä–∞—É–∑–µ—Ä–∞ -->
    <meta name="theme-color" content="#667eea">

    <!-- –î–ª—è iOS -->
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="MindGarden">

    <!-- –î–ª—è Android -->
    <meta name="mobile-web-app-capable" content="yes">

    <!-- –û—Ç–∫–ª—é—á–µ–Ω–∏–µ —Ç–µ–ª–µ—Ñ–æ–Ω–Ω—ã—Ö —Å—Å—ã–ª–æ–∫ -->
    <meta name="format-detection" content="telephone=no">

    <!-- –û—Ç–∫—Ä—ã–≤–∞—Ç—å —Å—Å—ã–ª–∫–∏ –≤ —ç—Ç–æ–º –∂–µ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–∏ -->
    <meta name="apple-touch-fullscreen" content="yes">

</head>
<body>
    <div class="container">
        <!-- –®–∞–ø–∫–∞ -->
        <header class="header">
            <div class="logo">
                <span class="logo-icon">üåø</span>
                <span class="logo-text">MindGarden</span>
            </div>
            <a href="index.html" class="back-btn">‚Üê –ù–∞–∑–∞–¥</a>
        </header>

        <!-- –û—Å–Ω–æ–≤–Ω–æ–π –∫–æ–Ω—Ç–µ–Ω—Ç -->
        <main class="main-content">
            <div class="settings-header">
                <h1>‚öôÔ∏è –ù–∞—Å—Ç—Ä–æ–π–∫–∏</h1>
                <p class="subtitle">–ù–∞—Å—Ç—Ä–æ–π—Ç–µ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ –ø–æ–¥ —Å–µ–±—è</p>
            </div>

            <div class="settings-sections">
                <!-- –£–≤–µ–¥–æ–º–ª–µ–Ω–∏—è -->
                <section class="settings-section">
                    <h2>üîî –£–≤–µ–¥–æ–º–ª–µ–Ω–∏—è</h2>
                    <div class="setting-item">
                        <div class="setting-info">
                            <h4>–ï–∂–µ–¥–Ω–µ–≤–Ω—ã–µ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è</h4>
                            <p>–ü–æ–ª—É—á–∞—Ç—å —Ü–∏—Ç–∞—Ç—É –¥–Ω—è –≤ —É–∫–∞–∑–∞–Ω–Ω–æ–µ –≤—Ä–µ–º—è</p>
                        </div>
                        <label class="switch">
                            <input type="checkbox" id="notificationsToggle">
                            <span class="slider"></span>
                        </label>
                    </div>
                    
                    <div class="setting-item">
                        <div class="setting-info">
                            <h4>–í—Ä–µ–º—è —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π</h4>
                            <p>–í—ã–±–µ—Ä–∏—Ç–µ —É–¥–æ–±–Ω–æ–µ –≤—Ä–µ–º—è –¥–ª—è –ø–æ–ª—É—á–µ–Ω–∏—è —Ü–∏—Ç–∞—Ç—ã</p>
                        </div>
                        <input type="time" id="notificationTime" class="time-input">
                    </div>
                </section>

                <!-- –¢–µ–º—ã —Ü–∏—Ç–∞—Ç -->
                <section class="settings-section">
                    <h2>üè∑Ô∏è –¢–µ–º—ã —Ü–∏—Ç–∞—Ç</h2>
                    <div class="setting-item">
                        <div class="setting-info">
                            <h4>–í—ã–±—Ä–∞–Ω–Ω—ã–µ —Ç–µ–º—ã</h4>
                            <p>–ò–∑–º–µ–Ω–µ–Ω–∏–µ —Ç–µ–º –ø–æ–≤–ª–∏—è–µ—Ç –Ω–∞ –æ—Ç–±–∏—Ä–∞–µ–º—ã–µ —Ü–∏—Ç–∞—Ç—ã</p>
                        </div>
                        <button class="btn" id="changeTagsBtn">–ò–∑–º–µ–Ω–∏—Ç—å —Ç–µ–≥–∏</button>
                    </div>
                    <div class="selected-tags" id="selectedTagsList">
                        <!-- –í—ã–±—Ä–∞–Ω–Ω—ã–µ —Ç–µ–≥–∏ –±—É–¥—É—Ç –ø–æ–∫–∞–∑–∞–Ω—ã –∑–¥–µ—Å—å -->
                    </div>
                </section>

                <!-- –í–Ω–µ—à–Ω–∏–π –≤–∏–¥ -->
                <section class="settings-section">
                    <h2>üé® –í–Ω–µ—à–Ω–∏–π –≤–∏–¥</h2>
                    <div class="setting-item">
                        <div class="setting-info">
                            <h4>–¢–µ–º–∞ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è</h4>
                            <p>–°–≤–µ—Ç–ª–∞—è –∏–ª–∏ —Ç–µ–º–Ω–∞—è —Ç–µ–º–∞</p>
                        </div>
                        <div class="theme-selector">
                            <button class="theme-option" data-theme="light">
                                <span>üåû</span> –°–≤–µ—Ç–ª–∞—è
                            </button>
                            <button class="theme-option" data-theme="dark">
                                <span>üåô</span> –¢–µ–º–Ω–∞—è
                            </button>
                            <button class="theme-option" data-theme="auto">
                                <span>‚öôÔ∏è</span> –ê–≤—Ç–æ
                            </button>
                        </div>
                    </div>
                </section>

                <!-- –î–∞–Ω–Ω—ã–µ -->
                <section class="settings-section">
                    <h2>üíæ –î–∞–Ω–Ω—ã–µ</h2>
                    <div class="setting-item">
                        <div class="setting-info">
                            <h4>–≠–∫—Å–ø–æ—Ä—Ç –¥–∞–Ω–Ω—ã—Ö</h4>
                            <p>–°–∫–∞—á–∞–π—Ç–µ —Ä–µ–∑–µ—Ä–≤–Ω—É—é –∫–æ–ø–∏—é –≤–∞—à–∏—Ö –¥–∞–Ω–Ω—ã—Ö</p>
                        </div>
                        <button class="btn-secondary" id="exportBtn">–≠–∫—Å–ø–æ—Ä—Ç</button>
                    </div>
                    
                    <div class="setting-item">
                        <div class="setting-info">
                            <h4>–ò–º–ø–æ—Ä—Ç –¥–∞–Ω–Ω—ã—Ö</h4>
                            <p>–í–æ—Å—Å—Ç–∞–Ω–æ–≤–∏—Ç–µ –¥–∞–Ω–Ω—ã–µ –∏–∑ —Ä–µ–∑–µ—Ä–≤–Ω–æ–π –∫–æ–ø–∏–∏</p>
                        </div>
                        <button class="btn-secondary" id="importBtn">–ò–º–ø–æ—Ä—Ç</button>
                    </div>
                    
                    <div class="setting-item">
                        <div class="setting-info">
                            <h4>–°–±—Ä–æ—Å –¥–∞–Ω–Ω—ã—Ö</h4>
                            <p>–£–¥–∞–ª–∏—Ç—å –≤—Å–µ –¥–∞–Ω–Ω—ã–µ –∏ –Ω–∞—á–∞—Ç—å –∑–∞–Ω–æ–≤–æ</p>
                        </div>
                        <button class="btn-danger" id="resetBtn">–°–±—Ä–æ—Å–∏—Ç—å –≤—Å—ë</button>
                    </div>
                </section>

                <!-- –ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è -->
                <section class="settings-section">
                    <h2>‚ÑπÔ∏è –ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è</h2>
                    <div class="info-items">
                        <div class="info-item">
                            <span class="info-label">–í–µ—Ä—Å–∏—è –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è:</span>
                            <span class="info-value">1.0.0</span>
                        </div>
                        <div class="info-item">
                            <span class="info-label">–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ —Ü–∏—Ç–∞—Ç:</span>
                            <span class="info-value" id="totalQuotesCount">0</span>
                        </div>
                        <div class="info-item">
                            <span class="info-label">–ò–∑–±—Ä–∞–Ω–Ω—ã–µ —Ü–∏—Ç–∞—Ç—ã:</span>
                            <span class="info-value" id="favoritesCount">0</span>
                        </div>
                        <div class="info-item">
                            <span class="info-label">–ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–æ –º–µ—Å—Ç–∞:</span>
                            <span class="info-value" id="storageUsed">0 KB</span>
                        </div>
                    </div>
                </section>

                <!-- –Æ—Ä–∏–¥–∏—á–µ—Å–∫–∞—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è -->
                <section class="settings-section legal-section">
                    <h2>‚öñÔ∏è –Æ—Ä–∏–¥–∏—á–µ—Å–∫–∞—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è</h2>
                    <div class="legal-links">
                        <a href="#" class="legal-link">–ü–æ–ª–∏—Ç–∏–∫–∞ –∫–æ–Ω—Ñ–∏–¥–µ–Ω—Ü–∏–∞–ª—å–Ω–æ—Å—Ç–∏</a>
                        <a href="#" class="legal-link">–£—Å–ª–æ–≤–∏—è –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è</a>
                        <a href="#" class="legal-link">–û—Ç–∫–∞–∑ –æ—Ç –æ—Ç–≤–µ—Ç—Å—Ç–≤–µ–Ω–Ω–æ—Å—Ç–∏</a>
                        <a href="#" class="legal-link">–°–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤–∏–µ 152-–§–ó</a>
                    </div>
                </section>
            </div>
        </main>

        <!-- –ù–∏–∂–Ω—è—è –Ω–∞–≤–∏–≥–∞—Ü–∏—è -->
        <nav class="bottom-nav">
            <a href="index.html" class="nav-item">
                <span>üè†</span>
                <span>–ì–ª–∞–≤–Ω–∞—è</span>
            </a>
            <a href="favorites.html" class="nav-item">
                <span>‚≠ê</span>
                <span>–ò–∑–±—Ä–∞–Ω–Ω–æ–µ</span>
            </a>
            <a href="settings.html" class="nav-item active">
                <span>‚öôÔ∏è</span>
                <span>–ù–∞—Å—Ç—Ä–æ–π–∫–∏</span>
            </a>
        </nav>
    </div>

    <script src="db.js"></script>
    <script>
        async function loadSettings() {
            const db = await initDB();
            const user = await db.getUser();
            const favorites = await db.getFavorites();
            const allQuotes = await db.getAllQuotes();
            
            // –ù–∞—Å—Ç—Ä–æ–π–∫–∏ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π
            const notificationsToggle = document.getElementById('notificationsToggle');
            const notificationTime = document.getElementById('notificationTime');
            
            notificationsToggle.checked = user.settings.notifications;
            notificationTime.value = user.settings.notificationTime;
            
            // –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –≤—Ä–µ–º–µ–Ω–∏ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π
            notificationTime.onchange = async () => {
                const updatedUser = {
                    ...user,
                    settings: {
                        ...user.settings,
                        notificationTime: notificationTime.value
                    }
                };
                await db.saveUser(updatedUser);
                showToast('–í—Ä–µ–º—è —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π —Å–æ—Ö—Ä–∞–Ω–µ–Ω–æ');
            };
            
            // –í–∫–ª—é—á–µ–Ω–∏–µ/–≤—ã–∫–ª—é—á–µ–Ω–∏–µ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π
            notificationsToggle.onchange = async () => {
                const updatedUser = {
                    ...user,
                    settings: {
                        ...user.settings,
                        notifications: notificationsToggle.checked
                    }
                };
                await db.saveUser(updatedUser);
                showToast(notificationsToggle.checked ? 
                    '–£–≤–µ–¥–æ–º–ª–µ–Ω–∏—è –≤–∫–ª—é—á–µ–Ω—ã' : '–£–≤–µ–¥–æ–º–ª–µ–Ω–∏—è –æ—Ç–∫–ª—é—á–µ–Ω—ã');
            };
            
            // –ü–æ–∫–∞–∑–∞—Ç—å –≤—ã–±—Ä–∞–Ω–Ω—ã–µ —Ç–µ–≥–∏
            await showSelectedTags(user.selectedTags);
            
            // –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞
            document.getElementById('totalQuotesCount').textContent = allQuotes.length;
            document.getElementById('favoritesCount').textContent = favorites.length;
            
            // –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–Ω–æ–µ –º–µ—Å—Ç–æ
            await calculateStorageUsage();
            
            // –¢–µ–º–∞ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è
            loadThemeSettings(user.settings.theme);
        }
        
        async function showSelectedTags(tags) {
            const container = document.getElementById('selectedTagsList');
            container.innerHTML = '';
            
            if (tags.length === 0) {
                container.innerHTML = '<p class="no-tags">–¢–µ–≥–∏ –Ω–µ –≤—ã–±—Ä–∞–Ω—ã</p>';
                return;
            }
            
            tags.forEach(tag => {
                const tagElement = document.createElement('span');
                tagElement.className = 'selected-tag';
                tagElement.innerHTML = `
                    <span class="tag-emoji">${getTagEmoji(tag)}</span>
                    <span class="tag-name">${getTagName(tag)}</span>
                `;
                container.appendChild(tagElement);
            });
        }
        
        function getTagName(tagId) {
            const names = {
                'motivation': '–ú–æ—Ç–∏–≤–∞—Ü–∏—è',
                'philosophy': '–§–∏–ª–æ—Å–æ—Ñ–∏—è',
                'success': '–£—Å–ø–µ—Ö',
                'wisdom': '–ú—É–¥—Ä–æ—Å—Ç—å',
                'love': '–õ—é–±–æ–≤—å',
                'life': '–ñ–∏–∑–Ω—å',
                'inspiration': '–í–¥–æ—Ö–Ω–æ–≤–µ–Ω–∏–µ',
                'happiness': '–°—á–∞—Å—Ç—å–µ',
                'work': '–†–∞–±–æ—Ç–∞',
                'creativity': '–ö—Ä–µ–∞—Ç–∏–≤–Ω–æ—Å—Ç—å',
                'nature': '–ü—Ä–∏—Ä–æ–¥–∞',
                'spirituality': '–î—É—Ö–æ–≤–Ω–æ—Å—Ç—å'
            };
            return names[tagId] || tagId;
        }
        
        function loadThemeSettings(currentTheme) {
            const themeOptions = document.querySelectorAll('.theme-option');
            
            themeOptions.forEach(option => {
                option.classList.remove('active');
                if (option.dataset.theme === currentTheme) {
                    option.classList.add('active');
                }
                
                option.onclick = async () => {
                    const db = await initDB();
                    const user = await db.getUser();
                    
                    const updatedUser = {
                        ...user,
                        settings: {
                            ...user.settings,
                            theme: option.dataset.theme
                        }
                    };
                    
                    await db.saveUser(updatedUser);
                    applyTheme(option.dataset.theme);
                    
                    // –û–±–Ω–æ–≤–ª—è–µ–º –∞–∫—Ç–∏–≤–Ω—É—é –∫–Ω–æ–ø–∫—É
                    themeOptions.forEach(opt => opt.classList.remove('active'));
                    option.classList.add('active');
                    
                    showToast('–¢–µ–º–∞ –∏–∑–º–µ–Ω–µ–Ω–∞');
                };
            });
        }
        
        function applyTheme(theme) {
            if (theme === 'dark' || (theme === 'auto' && window.matchMedia('(prefers-color-scheme: dark)').matches)) {
                document.documentElement.setAttribute('data-theme', 'dark');
            } else {
                document.documentElement.setAttribute('data-theme', 'light');
            }
        }
        
        async function calculateStorageUsage() {
            if (navigator.storage && navigator.storage.estimate) {
                const estimate = await navigator.storage.estimate();
                const usedMB = Math.round(estimate.usage / 1024 / 1024 * 100) / 100;
                const totalMB = Math.round(estimate.quota / 1024 / 1024 * 100) / 100;
                
                document.getElementById('storageUsed').textContent = 
                    `${usedMB} MB –∏–∑ ${totalMB} MB`;
            } else {
                document.getElementById('storageUsed').textContent = '–ù–µ–¥–æ—Å—Ç—É–ø–Ω–æ';
            }
        }
        
        async function exportData() {
            const db = await initDB();
            const user = await db.getUser();
            const favorites = await db.getFavorites();
            
            const exportData = {
                version: '1.0',
                exportedAt: new Date().toISOString(),
                user: user,
                favorites: favorites.map(fav => fav.quoteId)
            };
            
            const dataStr = JSON.stringify(exportData, null, 2);
            const dataBlob = new Blob([dataStr], { type: 'application/json' });
            
            const url = URL.createObjectURL(dataBlob);
            const link = document.createElement('a');
            link.href = url;
            link.download = `mindgarden-backup-${new Date().toISOString().split('T')[0]}.json`;
            link.click();
            
            URL.revokeObjectURL(url);
            showToast('–î–∞–Ω–Ω—ã–µ —ç–∫—Å–ø–æ—Ä—Ç–∏—Ä–æ–≤–∞–Ω—ã');
        }
        
        async function importData() {
            const input = document.createElement('input');
            input.type = 'file';
            input.accept = '.json';
            
            input.onchange = async (event) => {
                const file = event.target.files[0];
                if (!file) return;
                
                const reader = new FileReader();
                reader.onload = async (e) => {
                    try {
                        const data = JSON.parse(e.target.result);
                        
                        if (data.version !== '1.0') {
                            throw new Error('–ù–µ–≤–µ—Ä–Ω–∞—è –≤–µ—Ä—Å–∏—è —Ñ–∞–π–ª–∞');
                        }
                        
                        const db = await initDB();
                        
                        // –ò–º–ø–æ—Ä—Ç–∏—Ä—É–µ–º –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
                        await db.saveUser(data.user);
                        
                        // –ò–º–ø–æ—Ä—Ç–∏—Ä—É–µ–º –∏–∑–±—Ä–∞–Ω–Ω–æ–µ
                        for (const quoteId of data.favorites) {
                            await db.addToFavorites(quoteId);
                        }
                        
                        showToast('–î–∞–Ω–Ω—ã–µ —É—Å–ø–µ—à–Ω–æ –∏–º–ø–æ—Ä—Ç–∏—Ä–æ–≤–∞–Ω—ã');
                        setTimeout(() => {
                            window.location.reload();
                        }, 1500);
                        
                    } catch (error) {
                        alert('–û—à–∏–±–∫–∞ –∏–º–ø–æ—Ä—Ç–∞: ' + error.message);
                    }
                };
                
                reader.readAsText(file);
            };
            
            input.click();
        }
        
        function showToast(message) {
            const toast = document.createElement('div');
            toast.className = 'toast';
            toast.textContent = message;
            
            toast.style.cssText = `
                position: fixed;
                bottom: 80px;
                left: 50%;
                transform: translateX(-50%);
                background: rgba(0, 0, 0, 0.8);
                color: white;
                padding: 12px 24px;
                border-radius: 20px;
                z-index: 1000;
                font-size: 14px;
                animation: fadeInOut 3s ease-in-out;
            `;
            
            const style = document.createElement('style');
            style.textContent = `
                @keyframes fadeInOut {
                    0% { opacity: 0; transform: translate(-50%, 20px); }
                    10% { opacity: 1; transform: translate(-50%, 0); }
                    90% { opacity: 1; transform: translate(-50%, 0); }
                    100% { opacity: 0; transform: translate(-50%, -20px); }
                }
            `;
            document.head.appendChild(style);
            
            document.body.appendChild(toast);
            
            setTimeout(() => {
                toast.remove();
                style.remove();
            }, 3000);
        }
        
        // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è
        document.addEventListener('DOMContentLoaded', async () => {
            const db = await initDB();
            const user = await db.getUser();
            
            if (!user) {
                window.location.href = 'first-launch.html';
                return;
            }
            
            await loadSettings();
            
            // –û–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ –∫–Ω–æ–ø–æ–∫
            document.getElementById('changeTagsBtn').onclick = () => {
                window.location.href = 'first-launch.html?edit=true';
            };
            
            document.getElementById('exportBtn').onclick = exportData;
            document.getElementById('importBtn').onclick = importData;
            
            document.getElementById('resetBtn').onclick = async () => {
                if (confirm('–í–ù–ò–ú–ê–ù–ò–ï! –≠—Ç–æ —É–¥–∞–ª–∏—Ç –í–°–ï –≤–∞—à–∏ –¥–∞–Ω–Ω—ã–µ –±–µ–∑ –≤–æ–∑–º–æ–∂–Ω–æ—Å—Ç–∏ –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏—è. –ü—Ä–æ–¥–æ–ª–∂–∏—Ç—å?')) {
                    indexedDB.deleteDatabase(DB_NAME);
                    localStorage.clear();
                    showToast('–î–∞–Ω–Ω—ã–µ —É–¥–∞–ª–µ–Ω—ã');
                    setTimeout(() => {
                        window.location.href = 'first-launch.html';
                    }, 2000);
                }
            };
        });
    </script>
</body>
</html>